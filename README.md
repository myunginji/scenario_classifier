# 시나리오 분류기 (Scenario Classifier)

자율주행 데이터에서 다양한 주행 시나리오를 자동으로 라벨링하고 분류하는 도구입니다.

## 프로젝트 개요

이 프로젝트는 NuPlan 프레임워크를 기반으로 자율주행 로그 데이터에서 주행 시나리오를 자동으로 분류하고 라벨링하는 시스템입니다. JSON 형식의 주행 로그를 입력받아 다양한 주행 상황(차선변경, 정지, 회전 등)을 식별하고 시각화합니다.

## 주요 기능

### 🔍 시나리오 분류
- **4단계 분류 파이프라인**:
  1. 명시적 상태 분류 (속도, 위치 기반)
  2. 궤적 기반 행동 분류 (차선변경, 회전 등)
  3. 상호작용 기반 분류 (다른 차량/보행자와의 관계)
  4. 동역학 분류 (가속도, jerk 등)

### 📊 라벨 카테고리
- **속도 프로파일**: 저속, 중속, 고속 주행
- **정지 상황**: 일반 정지, 교통체증 정지
- **회전**: 좌회전, 우회전, 고속/저속 회전
- **차선변경**: 좌측/우측 차선변경
- **추종**: 선행차 추종, 느린 선행차 추종
- **근접**: 대형차량, 고속차량, 공사구역 등과의 근접
- **동역학**: 급가속, 급감속, 높은 측면 가속도

### 🗺️ 맵 기반 분석
- SQLite 기반 맵 데이터 관리
- 차선, 교차로, 정지선, 횡단보도 정보 활용
- 신호등 상태 정보 통합

### 📈 시각화
- ego 중심 좌표계 기반 시각화
- 차량 궤적 (과거/미래) 표시
- 주변 차량 및 보행자 표시
- 맵 요소 (차선, 횡단보도) 오버레이
- 분류된 라벨 정보 표시

## 파일 구조

```
src/
├── Start.py                    # 메인 실행 파일
├── ScenarioLabeler            # 핵심 시나리오 분류 클래스
├── CustomScenarioVisualizer   # 시각화 엔진
├── ScenarioExporter          # JSON 출력 모듈
├── DataTypes.py              # 데이터 구조 정의
├── JsonLogLoader.py          # JSON 로그 로더
├── MapManager.py             # 맵 데이터 관리자
├── ObjectTypes.py            # 객체 타입 정의
├── TrafficLightDataTypes.py  # 신호등 데이터 타입
├── DefaultParams.py          # 기본 설정 값
└── map.sqlite               # 맵 데이터베이스
```

## 설치 및 실행

### 요구사항
- Python 3.8+
- NuPlan 프레임워크
- 필수 패키지: `numpy`, `matplotlib`, `shapely`, `opencv-python`

### 설치
```bash
pip install -r requirements.txt
```

### 실행
```bash
python src/Start.py
```

## 설정

`src/DefaultParams.py`에서 다음 설정을 변경할 수 있습니다:

```python
# 데이터 파일 경로
LOG_FILE_NAME = "dataset/observation_log_20250307-094118.json"  # 입력 로그 파일
OUTPUT_DIR_SCENARIO_FILE = "./labeled_scenarios"               # JSON 출력 디렉토리
OUTPUT_DIR_IMAGE_FILE = "./imgs"                              # 이미지 출력 디렉토리

# 처리 옵션
MAX_SCENARIOS = -1  # 처리할 최대 시나리오 수 (-1 = 전체)
VISUALIZE = True    # 시각화 이미지 생성 여부
STEP_SIZE = 100     # 샘플링 간격 (1 = 전체, 큰 값 = 간격)

# 맵 설정
MAP_FILE_PATH = "src/map.sqlite"    # 맵 데이터베이스 경로
MAP_ORIGIN_X = 230388.61912         # 맵 원점 X 좌표 (UTM)
MAP_ORIGIN_Y = 424695.37128         # 맵 원점 Y 좌표 (UTM)
```

## 출력 결과

### JSON 출력
각 시나리오에 대해 다음 정보가 포함된 JSON 파일이 생성됩니다:
- 시나리오 ID 및 메타데이터
- ego 차량 위치, 속도 정보
- 분류된 라벨 및 신뢰도
- 101-epoch 전체 관측 데이터 (과거 40 + 현재 1 + 미래 60)
- 주변 차량/보행자 정보

### 시각화 이미지
각 시나리오에 대해 PNG 이미지가 생성됩니다:
- ego 중심 좌표계 (60m x 60m 범위)
- 차선 및 맵 요소 표시
- 차량 궤적 (과거: 실선, 미래: 점선)
- 분류된 라벨 오버레이

## 분류 알고리즘

### 신뢰도 기반 라벨링
각 라벨에는 0.0~1.0 범위의 신뢰도가 할당됩니다:
- 높은 신뢰도 (0.95~0.99): 속도, 정지, 맵 기반 라벨
- 중간 신뢰도 (0.80~0.95): 행동 기반, 상호작용 라벨
- 맞춤형 임계값: 각 라벨 유형별 최적화된 임계값 사용

### 101-epoch 윈도우
- 과거 40 프레임 + 현재 1 프레임 + 미래 60 프레임
- 20Hz 샘플링 기준 총 5.05초 구간
- 시간적 맥락을 고려한 정확한 분류

## 확장성

이 시스템은 다음과 같이 확장 가능합니다:
- 새로운 라벨 카테고리 추가
- 맞춤형 분류 규칙 구현
- 다양한 맵 형식 지원
- 실시간 분류 기능 추가

## 라이선스

이 프로젝트는 MIT 라이선스 하에 배포됩니다.